name: CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:

  # ==============================
  # 1ï¸âƒ£ Test trÃªn MongoDB local
  # ==============================
  test:
    name: Unit Tests (Mongo local)
    runs-on: ubuntu-latest

    # DÃ¹ng services Ä‘á»ƒ cÃ³ MongoDB (vÃ  RabbitMQ náº¿u product cáº§n connect)
    services:
      mongo:
        image: mongo:6
        ports:
          - 27017:27017            # MongoDB nghe á»Ÿ localhost:27017 trong runner
        # Náº¿u khÃ´ng cáº§n auth cho test, khÃ´ng set username/password
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })' || exit 1"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

      rabbitmq:
        image: rabbitmq:3-management # product gá»i app.setupMessageBroker() -> cáº§n amqp://localhost:5672
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'        # hoáº·c '20' tÃ¹y project

      # Táº¡o .env cho tá»«ng service (trá» vá» Mongo local)
      - name: Create .env for services
        run: |
          # AUTH
          mkdir -p auth
          cat > auth/.env << 'EOF'
          MONGODB_AUTH_URI=mongodb://127.0.0.1:27017/auth_test
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          # (tÃ¹y code auth cáº§n thÃªm gÃ¬ thÃ¬ bá»• sung)
          EOF

          # PRODUCT
          mkdir -p product
          cat > product/.env << 'EOF'
          MONGODB_PRODUCT_URI=mongodb://127.0.0.1:27017/product_test
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          # RABBITMQ_URL náº¿u code product Ä‘á»c tá»« env (khá»›p vá»›i app.setupMessageBroker())
          RABBITMQ_URL=amqp://127.0.0.1:5672
          EOF

      # CÃ i deps & cháº¡y test cho AUTH trÆ°á»›c
      - name: Install & Test (auth)
        working-directory: ./auth
        env:
          # Má»™t sá»‘ lib native cáº§n build tools; náº¿u cáº§n cÃ³ thá»ƒ thÃªm:
          # npm_config_build_from_source: true
          NODE_ENV: test
        run: |
          npm ci
          npm i -D chai@4.3.10 chai-http@4.4.0 mocha@10.3.0
          # Cháº¡y test auth: file test báº¡n Ä‘Æ°a sáº½ connect Mongo local, start app, register/login,...
          npm test

      # Khá»Ÿi cháº¡y AUTH á»Ÿ ná»n Ä‘á»ƒ PRODUCT test cÃ³ thá»ƒ gá»i http://localhost:3000/login
      - name: Start auth server (background)
        working-directory: ./auth
        env:
          NODE_ENV: test
        run: |
          nohup npm start >/tmp/auth.log 2>&1 &
          # chá» port 3000 sáºµn sÃ ng
          timeout 60 bash -c 'until echo > /dev/tcp/127.0.0.1/3000; do sleep 1; done'
          echo "Auth is up"
          # (tÃ¹y app cÃ³ /health thÃ¬ cÃ³ thá»ƒ dÃ¹ng curl http://localhost:3000/health)

      # CÃ i deps & cháº¡y test cho PRODUCT (sáº½ xin token tá»« AUTH vá»«a cháº¡y)
      - name: Install & Test (product)
        working-directory: ./product
        env:
          NODE_ENV: test
          LOGIN_TEST_USER: ${{ secrets.LOGIN_TEST_USER }}              # dÃ¹ng trong bÃ i test
          LOGIN_TEST_PASSWORD: ${{ secrets.LOGIN_TEST_PASSWORD }}
        run: |
          npm ci
          npm i -D chai@4.3.10 chai-http@4.4.0 mocha@10.3.0
          npm test

  # ==============================
  # 2ï¸âƒ£ Build & Push Docker Images
  # ==============================
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test                         # ðŸ”’ Chá»‰ build/push khi test pass
    strategy:
      matrix:
        service: [api-gateway, auth, product, order]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}                     # ThÆ° má»¥c service
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64                  # build multi-arch

  # ==============================
  # 3ï¸âƒ£ Deploy trÃªn Windows Runner
  # ==============================
  deploy:
    name: Deploy on Localhost (Windows Runner)
    needs: build-and-push
    runs-on: self-hosted          # Windows self-hosted runner
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}  # âš ï¸ dÃ¹ng biáº¿n nÃ y bÃªn dÆ°á»›i
    steps:
      - name: Check Docker environment
        shell: cmd
        run: |
          echo Checking Docker environment...
          docker --version
          docker-compose --version

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Stop and remove old containers
        shell: cmd
        run: |
          echo Stopping old containers...
          cd /d D:\MÃ´n há»c\Nam 4\Lap Trinh Huong Dich Vu\22654301_TranDuBao_EProject-1\EProject-Phase-1\EProject-Phase-1>
          docker-compose down --remove-orphans
